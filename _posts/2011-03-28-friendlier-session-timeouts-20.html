---
layout: post
title: Friendlier Session Timeouts 2.0
date: '2011-03-28T21:44:00.000-07:00'
author: ndp
tags:
- sessions
- software development
- rails
- design
- javascript
modified_time: '2011-04-01T07:57:55.074-07:00'
thumbnail: http://4.bp.blogspot.com/-dAHRdyyCfuM/TZFhGYWnjVI/AAAAAAAAAy0/NWMu5i06-M0/s72-c/Picture%2B7.png
---

As we discovered today, coding up friendly session time-outs involves more than meets the eye. As you know, a session time-out logs the user out after a period of inactivity. But interactions with web sites, and "inactivity," have changed over the last 10-15 years.<br /><br />We have a fairly plain Rails app, and we're implementing a series of security fixes in anticipation of an audit. In what seemed like a simple "1-pointer", we were asked to remove the "Remember Me" checkbox from our application, and force the user to be logged out after 20 minutes. <br /><br />For the first pass, we simply set the session timeout to 20 minutes and removed the checkbox (and the underlying implementation). Easy eh?<br /><br />Sadly, this solution leaves much to be desired. When the user (or Q.A. engineer) returns after 1/2 hour, the page is unchanged and ready for action. But any click redirects, confuses, and potentially loses in-progress work.<br /><br />Although this might have be acceptable in 1998, it's 2011 and we got Ajax. Clicking a link on a Web 1.0 site takes you to another page; if you happen to be logged out, oh well, sign back in and continue-- you probably weren't doing something that important anyhow. <br /><br />But these days, on an Ajax page, if your session expires while you're viewing the page, clicking on any element of the page can reveal a session timeout. This may appear to the user as a server error, or if it's handled correctly (like we did), a page redirect. Clicking on a disclosure triangle redirects to a new page? Now we have a surprised user.<br /><br /><div class="separator" style="font-size: 80%; clear: both; background-color: #eee; text-align: left;"><a href="http://4.bp.blogspot.com/-dAHRdyyCfuM/TZFhGYWnjVI/AAAAAAAAAy0/NWMu5i06-M0/s1600/Picture%2B7.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="246" src="http://4.bp.blogspot.com/-dAHRdyyCfuM/TZFhGYWnjVI/AAAAAAAAAy0/NWMu5i06-M0/s320/Picture%2B7.png" width="320" /></a></div><br />I Googled a bit and found lots of bug reports around this behavior. As this Jira snapshot shows, resolving this might be trickier than anticipated.<br /><br />I checked out my bank's solution. It looked like they implemented a whole timeout scheme in Javascript. Were they wacko? (No... but we'll get there.)<br /><br />Of the hand full of ideas out there on the web, here's one solution (<a href="http://www.sidesofmarch.com/index.php/archive/2005/01/30/friendly-session-timeouts-the-javascript-way/">of a hand full</a>) with the idea of timing the session in Javascript:<br /><code><br />&lt;script language="javascript"&gt;<br /><br />function confirmLogoff() {<br />&nbsp; if (confirm("Your session will end in one minute.\n\nPress OK to continue for another ten minutes.")){<br />&nbsp; location.reload();<br />&nbsp; }<br />}<br />setTimeout("confirmLogoff()", <%= sessionTimeout - 1000*60 %>);<br />&lt;/script&gt;<br /></code><br /><br />At first blush this looks like they might be on to something. Alas no. The confirmation will only work the brief period between the client and the server timeout. I'd argue it's even worse than no solution, since the messages promises something it can't deliver on, and loses the user's work-in-progress.<br /><br />Did I mention we have <b>quite a few pages with AJAX requests</b> on them? These conveniently extend the session timeout on the server when the user interacts with them. But they break any sort of client-side timer that is set up at page load. Any sort of "meta refresh" schemes doing something similar to the above were quickly dismissed.<br /><br />And why should just AJAX backed behaviors restart this timer? Opening a hidden panel may or may not go to the server (depending on an developer's whim), but should this whim this really affect the user's timeout? So we started considering implementations that ping the server as the user interacts. This was also dismissed as being complicated to implement efficiently (and potentially introducing some sort of security issue).<br /><br />Finally where we "settled" (as in prom date), is implementing a timeout within Javascript, like my bank. It's a little more sophisticated: it's reset not only by the initial page load, but all sorts of user interactions. The code finally reduced down to:<br /><code><br />var clientSessionTimeout = function(timeoutMS, logoutFn) {<br />&nbsp; var lastTimeout;<br /><br />&nbsp; var startSessionTimeout = function() {<br />&nbsp;&nbsp;&nbsp; if (lastTimeout) clearTimeout(lastTimeout);<br />&nbsp;&nbsp;&nbsp; lastTimeout = setTimeout(function() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logoutFn();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }, timeoutMS);<br />&nbsp; };<br /><br />&nbsp; // Watch for activity<br />&nbsp; $('body').click(startSessionTimeout).keydown(startSessionTimeout);<br />&nbsp; startSessionTimeout();<br />};<br /></code><br /><br />This is called with the 20-minute timeout, and implements it beautifully:<br /><code><br />&nbsp;&nbsp;&nbsp; clientSessionTimeout(20 * 60 * 1000, function() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; document.location = '/timeout?return_to=' + document.location.href;<br />&nbsp;&nbsp;&nbsp; });<br /></code><br /><br />The server side timeout is for redundancy. Our pages are all pretty focused, so I doubt any user will spend more than a couple minutes on any one of them. We picked a server-side session timeout of 40 minutes. The only way the Javascript timeout won't kick in first is if the user interacts with the page for more than this time with no server side interaction... possible, but not likely.<br /><br />After completing this compromise solution, I'm ready to spell out some ideal requirements:<br />* session timeout with no interaction after 20 minutes<br />* any interaction on the page should reset the timeout<br />* warn the user (if possible) when the deadline approaches<br />* this shouldn't open additional security vulnerabilities or server traffic<br /><br />With some additional work, I'm sure an "ideal" solution can be developed. This compromise should get us most of the way there. Thanks to the rest of my team, and an interview candidate who provided some clear thinking on the matter.