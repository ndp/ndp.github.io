---
layout: post
title: "Rails Fixtures with Integrity & Validity"
date: 2010-03-06
comments: false
url: /2010/03/rails-fixtures-with-integrity-validity.html/2010-03-06-rails-fixtures-with-integrity-validity.html
tags:
 - unit testing
 - rails
 - agile
 - tdd
---

<div class='post'>
A new developer on the project changed the symbolic name of one fixture record&nbsp; and&nbsp;broke a whole bunch of tests in unexpected ways. Pairing, we discovered a some interesting stuff.<br /><br />First, if you've never dug into them, it's critical to understand how symbollically named&nbsp;fixtures work. We rely on them heavily, but only yesterday read the code.&nbsp;If you have a fixture like:<br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">bill:</span><br /><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; full_name: ...</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px; min-height: 14.0px;"><br /></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;">And another fixture:</div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">socks:</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; owner: bill</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px; min-height: 14.0px;"><span class="Apple-style-span" style="font-family: Times, Courier, monospace;"><span class="Apple-style-span" style="font-size: medium;"><span class="Apple-style-span" style="font-family: Helvetica; font-size: small;"><span class="Apple-style-span" style="font-size: 12px;"><br /></span></span></span></span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;">Rails magically inserts bill's ID into socks' record. (Before this feature, developers had to manually manage their IDs and keeping fixtures working well was less fun.)</span></span><span class="Apple-style-span" style="font-size: medium;"><span class="Apple-style-span" style="font-family: Times;"></span></span><span class="Apple-style-span" style="font-size: medium;"><span class="Apple-style-span" style="font-family: Times;"></span></span><span class="Apple-style-span" style="font-size: medium;"><span class="Apple-style-span" style="font-family: Times;"></span></span><span class="Apple-style-span" style="font-size: medium;"><span class="Apple-style-span" style="font-family: Times;"></span></span><span class="Apple-style-span" style="font-size: medium;"><span class="Apple-style-span" style="font-family: Times;"></span></span><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;"><br /></span> </span><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;"><br /></span> </span></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;">Nifty. I assumed (incorrectly), that there was some sort of lookup of records involved. So if I change the name of the "bill" fixture to something else-- let's say "william", I expect Rails to complain. It doesn't. There's no data integrity to the fixture system-- at all.</span></span></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;"><br /></span> </span><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;">We traced though the code and now understand why: When Rails comes across the symbol "bill", it creates an integer hash of it and sticks it into the id column. It'll be a big number like 39384022 or something. Well, if you change the name to "william", it generates a different hash. That's it. At no time does it go back to verify that such a hash exists. It's really just a nice name for a number! Unless your database has constraints that enforce this (which will make loading fixtures more difficult and generally isn't done), you won't see a problem until a test fails.</span></span><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;"><br /></span> </span><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;"></span></span><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;"></span></span><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;"></span></span><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;"></span></span><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;"></span></span><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;"><br /></span></span></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;">Once we discovered that, we asked, "wouldn't be nice if there was a test that checked the integrity of the fixtures?" With a little work, we had just such a test, which relies on the validation system:</span></span><span class="Apple-style-span" style="font-size: medium;"><span class="Apple-style-span" style="font-family: Times;"></span></span><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;"><br /></span> </span>describe "fixture integrity" do</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; ActiveRecord::Base.send(:subclasses).each do |cls|</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; it "each fixture for class #{cls} should be valid" do</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; cls</span><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">.find_each do |record|</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;record.valid?.should(equal(true),"Invalid fixture for #{cls}:\n &nbsp;#{record.errors.full_messages.join("\n")}\n#{record.inspect}")</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp;end</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; end</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; end</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">end</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px; min-height: 14.0px;"><br /></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="Apple-style-span" style="font-family: Times;"><span class="Apple-style-span" style="font-size: medium;">Unfortunately that passed until we added a the appropriate validator<br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: 12px;">class Child &lt; ActiveRecord::Base</span></span></span></span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; validates_presence_of :parent</span></div><div style="font: 12.0px Helvetica; margin: 0.0px 0.0px 0.0px 0.0px;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp; ...</span></div><br />(Make sure you validate "parent", not "parent_id". "parent_id" will be set-- it just won't point to anything.)<br /><div><br />That's it. A simple test and you won't risk your fixtures floating too far from the data structure you expect. Thanks to Lowell Kirsh and Jonah for pairing on this.</div></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>ndp</div>
<div class='content'>
@Alon -- that&#39;s right. I fixed the example. Sorry for the confusion.</div>
</div>
<div class='comment'>
<div class='author'>Alon Salant</div>
<div class='content'>
I wouldn&#39;t normally use &#39;owner_id: bill&#39;. I&#39;d use &#39;owner: bill&#39; and rely on Rails to know that &#39;owner&#39; is a relationship and it should be adding the value to &#39;owner_id&#39; in the database. This the ole &#39;foxy fixtures&#39; behavior introduced in Rails 2 at some point. I believe the behavior will be the same that you describe.</div>
</div>
</div>
